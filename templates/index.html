{% extends 'base.html' %}

{% block content %}
<!-- Socket.IO í´ë¼ì´ì–¸íŠ¸ -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<section class="card">
  <div class="upload-header">
    <label for="images">ì˜ì–‘ì •ë³´ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)</label>
    <a href="{{ url_for('download_samples') }}" class="sample-download-btn" title="ìƒ˜í”Œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ">
      ğŸ“¥ ìƒ˜í”Œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    </a>
  </div>
  
  <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" id="upload-form">
    
    <div class="dropzone" id="dropzone">
      <div class="dropzone-content">
        <div class="dropzone-icon">ğŸ“</div>
        <div class="dropzone-text">
          <p><strong>ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</strong></p>
          <p class="dropzone-subtext">PNG, JPG, JPEG, WEBP íŒŒì¼ ì§€ì›</p>
        </div>
      </div>
      <input type="file" id="images" name="images" accept="image/*" multiple style="display: none;" />
    </div>
    
    <div class="file-list" id="file-list" style="display: none;">
      <h4>ì„ íƒëœ íŒŒì¼:</h4>
      <div class="files" id="files"></div>
    </div>
    
    <div class="button-group">
      <button type="submit" id="analyze-btn" disabled>ë¶„ì„í•˜ê¸°</button>
      {% if results %}
      <form method="post" action="{{ url_for('reset') }}" style="display: inline;">
        <button type="submit" class="reset-btn" onclick="clearFlashMessages()">ì´ˆê¸°í™”</button>
      </form>
      {% endif %}
    </div>
    
    <!-- íŒŒì¼ ì„ íƒ í›„ ë°”ë¡œ ë¶„ì„ í™•ì¸ -->
    <div class="analysis-confirmation" id="analysis-confirmation" style="display: none;">
      <div class="confirmation-message">
        <span id="file-count">0</span>ê°œì˜ íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
      </div>
      <div class="confirmation-buttons">
        <button type="button" id="start-analysis-btn" class="btn-primary">ë¶„ì„ ì‹œì‘</button>
        <button type="button" id="cancel-analysis-btn" class="btn-secondary">ì·¨ì†Œ</button>
      </div>
    </div>
    
    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
    <div class="progress-container" id="progress-container" style="display: none;">
      <div class="loading-animation">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">ì˜ì–‘ì •ë³´ ë¶„ì„ ì¤‘...</div>
      </div>
      
      <div class="progress-header">
        <h4>ì „ì²´ ì²˜ë¦¬ ì§„í–‰ í˜„í™©</h4>
        <div class="progress-summary" id="progress-summary">0%</div>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-percentage" id="progress-percentage">0%</div>
      </div>
      
      <!-- ìƒì„¸ ë‹¨ê³„ë³„ ì§„í–‰ í˜„í™© -->
      <div class="analysis-steps-detailed">
        <div class="step-detailed" id="step-upload">
          <div class="step-header">
            <div class="step-icon">ğŸ“</div>
            <div class="step-info">
              <div class="step-title">íŒŒì¼ ì—…ë¡œë“œ</div>
              <div class="step-description">ì´ë¯¸ì§€ íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡ì¤‘...</div>
            </div>
            <div class="step-status" id="status-upload">â³</div>
          </div>
          <div class="step-progress">
            <div class="step-progress-bar">
              <div class="step-progress-fill" id="progress-upload"></div>
            </div>
            <div class="step-progress-text" id="progress-text-upload">ëŒ€ê¸°ì¤‘...</div>
          </div>
        </div>
        
        <div class="step-detailed" id="step-ocr">
          <div class="step-header">
            <div class="step-icon">ğŸ”</div>
            <div class="step-info">
              <div class="step-title">OCR ë¶„ì„</div>
              <div class="step-description">ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œì¤‘...</div>
            </div>
            <div class="step-status" id="status-ocr">â³</div>
          </div>
          <div class="step-progress">
            <div class="step-progress-bar">
              <div class="step-progress-fill" id="progress-ocr"></div>
            </div>
            <div class="step-progress-text" id="progress-text-ocr">ëŒ€ê¸°ì¤‘...</div>
          </div>
        </div>
        
        <div class="step-detailed" id="step-nutrition">
          <div class="step-header">
            <div class="step-icon">ğŸ§ª</div>
            <div class="step-info">
              <div class="step-title">ì˜ì–‘ì •ë³´ ì¶”ì¶œ</div>
              <div class="step-description">ì˜ì–‘ì„±ë¶„ ë°ì´í„°ë¥¼ ë¶„ì„ì¤‘...</div>
            </div>
            <div class="step-status" id="status-nutrition">â³</div>
          </div>
          <div class="step-progress">
            <div class="step-progress-bar">
              <div class="step-progress-fill" id="progress-nutrition"></div>
            </div>
            <div class="step-progress-text" id="progress-text-nutrition">ëŒ€ê¸°ì¤‘...</div>
          </div>
        </div>
        
        <div class="step-detailed" id="step-recommendation">
          <div class="step-header">
            <div class="step-icon">ğŸ¤–</div>
            <div class="step-info">
              <div class="step-title">AI ì¶”ì²œ ìƒì„±</div>
              <div class="step-description">ë§ì¶¤í˜• ì˜ì–‘ ì¡°ì–¸ì„ ìƒì„±ì¤‘...</div>
            </div>
            <div class="step-status" id="status-recommendation">â³</div>
          </div>
          <div class="step-progress">
            <div class="step-progress-bar">
              <div class="step-progress-fill" id="progress-recommendation"></div>
            </div>
            <div class="step-progress-text" id="progress-text-recommendation">ëŒ€ê¸°ì¤‘...</div>
          </div>
        </div>
        
        <div class="step-detailed" id="step-complete">
          <div class="step-header">
            <div class="step-icon">âœ…</div>
            <div class="step-info">
              <div class="step-title">ë¶„ì„ ì™„ë£Œ</div>
              <div class="step-description">ëª¨ë“  ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
            </div>
            <div class="step-status" id="status-complete">â³</div>
          </div>
          <div class="step-progress">
            <div class="step-progress-bar">
              <div class="step-progress-fill" id="progress-complete"></div>
            </div>
            <div class="step-progress-text" id="progress-text-complete">ëŒ€ê¸°ì¤‘...</div>
          </div>
        </div>
      </div>
    </div>
  </form>
</section>

{% if results %}
<section class="card results">
  <h2>
    ê²°ê³¼ ìš”ì•½
    {% set total_files = results.images|length %}
    {% set success_files = results.images|selectattr("status", "equalto", "success")|list|length %}
    {% set failed_files = total_files - success_files %}
    
    {% if failed_files > 0 %}
      <span class="completion-status partial">
        (ë¶€ë¶„ ì™„ë£Œ: {{ success_files }}/{{ total_files }}ê°œ íŒŒì¼ ì„±ê³µ)
      </span>
    {% else %}
      <span class="completion-status complete">
        (ì™„ë£Œ: {{ total_files }}ê°œ íŒŒì¼ ëª¨ë‘ ì„±ê³µ)
      </span>
    {% endif %}
  </h2>
  <div class="persons">
    <div class="person-card">
      <h3>ë‚¨ì ê¸°ì¤€</h3>
      <div class="water-glass male" data-percent="{{ results.male_calorie_achievement }}">
        <div class="glass-container">
          <div class="water-fill"></div>
          <div class="glass-overlay"></div>
          <div class="percentage-display">{{ results.male_calorie_achievement }}%</div>
        </div>
      </div>
      <div class="achievement-info">
        <div class="pct">ì¹¼ë¡œë¦¬ {{ results.male_calorie_achievement }}%</div>
        <div class="overall">ì „ì²´ í‰ê·  {{ results.male_overall }}%</div>
      </div>
    </div>
    <div class="person-card">
      <h3>ì—¬ì ê¸°ì¤€</h3>
      <div class="water-glass female" data-percent="{{ results.female_calorie_achievement }}">
        <div class="glass-container">
          <div class="water-fill"></div>
          <div class="glass-overlay"></div>
          <div class="percentage-display">{{ results.female_calorie_achievement }}%</div>
        </div>
      </div>
      <div class="achievement-info">
        <div class="pct">ì¹¼ë¡œë¦¬ {{ results.female_calorie_achievement }}%</div>
        <div class="overall">ì „ì²´ í‰ê·  {{ results.female_overall }}%</div>
      </div>
    </div>
  </div>

  <h3>ì„¸ë¶€ í•­ëª© (ì „ì²´ íŒ¨í‚¤ì§€ ê¸°ì¤€)</h3>
  <div class="scroll">
    <table class="nutrition-table">
      <thead>
        <tr>
          <th>íŒŒì¼ëª…</th>
          {% for k in results.display_order %}
          {% if k in results.totals %}
          <th>{{ {
            'calories_kcal':'ì—´ëŸ‰<br/>(kcal)', 'sodium_mg':'ë‚˜íŠ¸ë¥¨<br/>(mg)', 'carbs_g':'íƒ„ìˆ˜í™”ë¬¼<br/>(g)',
            'sugars_g':'ë‹¹ë¥˜<br/>(g)', 'fat_g':'ì§€ë°©<br/>(g)', 'sat_fat_g':'í¬í™”ì§€ë°©<br/>(g)', 'trans_fat_g':'íŠ¸ëœìŠ¤ì§€ë°©<br/>(g)',
            'cholesterol_mg':'ì½œë ˆìŠ¤í…Œë¡¤<br/>(mg)', 'protein_g':'ë‹¨ë°±ì§ˆ<br/>(g)', 'total_volume_g':'ë‚´ìš©ëŸ‰<br/>(g)', 'total_volume_ml':'ë‚´ìš©ëŸ‰<br/>(ml)'
          }[k]|safe }}</th>
          {% endif %}
          {% endfor %}
          <th>ë‚¨ì%</th>
          <th>ì—¬ì%</th>
        </tr>
      </thead>
      <tbody>
        <!-- í•©ê³„ í–‰ -->
        <tr class="total-row">
          <td><strong>í•©ê³„</strong></td>
          {% for k in results.display_order %}
          {% if k in results.totals %}
          <td>
            <strong>{{ '%.1f'|format(results.totals[k]) if results.totals[k] is not none else '-' }}</strong>
            {% if k in results.male_pct and results.male_pct[k] %}
              {% set male_pct_val = results.male_pct[k] %}
              {% if male_pct_val < 80 %}
                <span class="arrow insufficient" title="ë¶€ì¡±">ğŸ”»</span>
              {% elif male_pct_val > 120 %}
                <span class="arrow excess" title="ì´ˆê³¼">âš ï¸</span>
              {% else %}
                <span class="arrow optimal" title="ì ì •">âœ…</span>
              {% endif %}
            {% endif %}
          </td>
          {% endif %}
          {% endfor %}
          <td>
            <div class="bar"><span style="width: {{ results.male_overall }}%"></span></div>
            <small><strong>{{ results.male_overall }}%</strong></small>
          </td>
          <td>
            <div class="bar"><span style="width: {{ results.female_overall }}%"></span></div>
            <small><strong>{{ results.female_overall }}%</strong></small>
          </td>
        </tr>
        
        <!-- ê°œë³„ íŒŒì¼ í–‰ë“¤ -->
        {% for r in results.images %}
        <tr class="{{ 'pass-row' if r.status == 'pass' else ('error-row' if r.status == 'error' else '') }}">
          <td>
            {{ r.filename }}
            {% if r.status == 'pass' %}
            <span class="status-badge pass" title="{{ r.get('error', 'OCR ë¶„ì„ ì‹¤íŒ¨') }}">PASS</span>
            {% elif r.status == 'error' %}
            <span class="status-badge error" title="{{ r.get('error', 'ë¶„ì„ ì‹¤íŒ¨') }}">âŒ</span>
            {% else %}
            <span class="status-badge success">âœ…</span>
            {% endif %}
          </td>
          {% for k in results.display_order %}
          {% if k in results.totals %}
          <td>
            {% if r.status == 'pass' %}
              <span class="pass-text">PASS</span>
            {% elif r.status == 'error' %}
              0.0
            {% elif r.full_package and r.full_package.get(k) is not none %}
              {{ '%.1f'|format(r.full_package.get(k, 0)) }}
            {% else %}
              -
            {% endif %}
          </td>
          {% endif %}
          {% endfor %}
          <td>-</td>
          <td>-</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ì„¬ë„¤ì¼ ìŠ¬ë¼ì´ë” -->
  <div class="image-gallery">
    <h3>ğŸ“· ì—…ë¡œë“œëœ ì´ë¯¸ì§€ {{ results.images|length }}ê°œ</h3>
    <div class="gallery-container">
      <button class="gallery-nav prev" id="gallery-prev">â€¹</button>
      <div class="gallery-viewport">
        <div class="gallery-track" id="gallery-track">
          {% for r in results.images %}
          <div class="gallery-item {{ 'pass' if r.status == 'pass' else 'success' }}" data-filename="{{ r.filename }}" data-status="{{ r.status }}">
            <div class="thumbnail-container" onclick="showImageDetail('{{ r.filename }}', '{{ r.status }}', '{{ r.image_url if r.image_url else '' }}', {{ (r.fields|tojson)|safe if r.fields else 'null' }}, {{ (r.full_package|tojson)|safe if r.full_package else 'null' }})">
              <div class="thumbnail-placeholder">
                {% if r.image_url %}
                  <img src="{{ r.image_url }}" alt="{{ r.filename }}" class="thumbnail-image" />
                {% else %}
                  <div class="image-icon">ğŸ–¼ï¸</div>
                {% endif %}
                
                {% if r.status == 'pass' %}
                  <div class="error-overlay">
                    <span class="error-icon">âŒ</span>
                    <span class="error-text">ë¶„ì„ ì‹¤íŒ¨</span>
                  </div>
                {% else %}
                  <div class="success-overlay">
                    <span class="success-icon">âœ…</span>
                  </div>
                {% endif %}
                
                <!-- í´ë¦­ íŒíŠ¸ -->
                <div class="click-hint">
                  <span class="hint-icon">ğŸ”</span>
                  <span class="hint-text">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</span>
                </div>
              </div>
              <div class="thumbnail-info">
                <div class="filename">{{ r.filename }}</div>
                <div class="status {{ r.status }}">
                  {% if r.status == 'pass' %}
                    PASS
                  {% elif r.status == 'success' %}
                    ì™„ë£Œ
                  {% else %}
                    ì˜¤ë¥˜
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      <button class="gallery-nav next" id="gallery-next">â€º</button>
    </div>
    <div class="gallery-indicators">
      {% for r in results.images %}
      <span class="indicator {{ 'active' if loop.first else '' }}" data-index="{{ loop.index0 }}"></span>
      {% endfor %}
    </div>
  </div>

  <details class="files">
    <summary>ë¶„ì„ëœ íŒŒì¼ {{ results.images|length }}ê°œ (ì›ë³¸ ë°ì´í„°)</summary>
    <ul>
      {% for r in results.images %}
      <li>
        <strong>{{ r.filename }}</strong>
        {% if r.status == 'pass' %}
        <div><small>ìƒíƒœ:</small> <span class="pass-text">PASS (OCR ë¶„ì„ ì‹¤íŒ¨)</span></div>
        <div><small>ì˜¤ë¥˜:</small> <code>{{ r.error }}</code></div>
        {% else %}
        <div><small>100g ê¸°ì¤€:</small> <code>{{ r.fields }}</code></div>
        <div><small>ì „ì²´ íŒ¨í‚¤ì§€:</small> <code>{{ r.full_package }}</code></div>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </details>

  <!-- ì˜ì–‘ ìƒíƒœ ë¶„ì„ ë° ì¶”ì²œ ì„¹ì…˜ -->
  {% if results.male_deficient or results.female_deficient or results.male_excessive or results.female_excessive %}
  <div class="recommendation-section">
    <h3>ğŸ“Š ì˜ì–‘ ìƒíƒœ ë¶„ì„ ë° ê°œì„  ë°©ì•ˆ</h3>
    
    <div class="recommendation-tabs">
      <button class="tab-btn active" onclick="showRecommendation('male')">ë‚¨ì„± ê¸°ì¤€</button>
      <button class="tab-btn" onclick="showRecommendation('female')">ì—¬ì„± ê¸°ì¤€</button>
    </div>
    
    <div class="recommendation-content">
      <!-- ë‚¨ì„± ê¸°ì¤€ ì¶”ì²œ -->
      <div id="male-recommendation" class="recommendation-panel active">
        {% if results.male_deficient %}
        <div class="deficient-nutrients">
          <h4>ğŸ”» ë¶€ì¡±í•œ ì˜ì–‘ì†Œ:</h4>
          <div class="nutrient-chips">
            {% for nutrient, deficit in results.male_deficient.items() %}
            <span class="nutrient-chip deficient">
              {{ {
                'calories_kcal':'ì—´ëŸ‰', 'sodium_mg':'ë‚˜íŠ¸ë¥¨', 'carbs_g':'íƒ„ìˆ˜í™”ë¬¼',
                'sugars_g':'ë‹¹ë¥˜', 'fat_g':'ì§€ë°©', 'sat_fat_g':'í¬í™”ì§€ë°©', 'trans_fat_g':'íŠ¸ëœìŠ¤ì§€ë°©',
                'cholesterol_mg':'ì½œë ˆìŠ¤í…Œë¡¤', 'protein_g':'ë‹¨ë°±ì§ˆ'
              }[nutrient] }}
            </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if results.male_excessive %}
        <div class="excessive-nutrients">
          <h4>ğŸ”º ê³¼ë‹¤ ì„­ì·¨í•œ ì˜ì–‘ì†Œ:</h4>
          <div class="nutrient-chips">
            {% for nutrient, excess in results.male_excessive.items() %}
            <span class="nutrient-chip excessive">
              {{ {
                'calories_kcal':'ì—´ëŸ‰', 'sodium_mg':'ë‚˜íŠ¸ë¥¨', 'carbs_g':'íƒ„ìˆ˜í™”ë¬¼',
                'sugars_g':'ë‹¹ë¥˜', 'fat_g':'ì§€ë°©', 'sat_fat_g':'í¬í™”ì§€ë°©', 'trans_fat_g':'íŠ¸ëœìŠ¤ì§€ë°©',
                'cholesterol_mg':'ì½œë ˆìŠ¤í…Œë¡¤', 'protein_g':'ë‹¨ë°±ì§ˆ'
              }[nutrient] }}
            </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if results.male_deficient %}
        <div class="recommendation-text">
          <h4>ğŸ ë¶€ì¡±í•œ ì˜ì–‘ì†Œ ë³´ì¶© ë°©ë²•:</h4>
          <div class="recommendation-content-text">
            {% if results.male_recommendation and results.male_recommendation.strip() %}
              {{ results.male_recommendation | nl2br | safe }}
            {% else %}
              <p>ğŸ’¡ ìœ„ì— í‘œì‹œëœ ì˜ì–‘ì†Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ê· í˜• ì¡íŒ ì‹ë‹¨ì„ í†µí•´ ë¶€ì¡±í•œ ì˜ì–‘ì†Œë¥¼ ë³´ì¶©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
              <p>ğŸ” LLM APIê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒì„¸í•œ ì¶”ì²œì„ ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if results.male_excessive %}
        <div class="reduction-text">
          <h4>âš ï¸ ê³¼ë‹¤ ì„­ì·¨ ì˜ì–‘ì†Œ ê°ì†Œ ë°©ë²•:</h4>
          <div class="reduction-content-text">
            {% if results.male_reduction and results.male_reduction.strip() %}
              {{ results.male_reduction | nl2br | safe }}
            {% else %}
              <p>âš ï¸ ìœ„ì— í‘œì‹œëœ ì˜ì–‘ì†Œë¥¼ ê³¼ë‹¤ ì„­ì·¨í–ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ì˜ì–‘ì†Œê°€ ë§ì´ í¬í•¨ëœ ìŒì‹ì„ ì¤„ì´ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
              <p>ğŸ” LLM APIê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒì„¸í•œ ê°ì†Œ ë°©ë²•ì„ ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if not results.male_deficient and not results.male_excessive %}
        <div class="no-recommendation">
          <p>ğŸ‰ ëª¨ë“  ì˜ì–‘ì†Œê°€ ì ì • ìˆ˜ì¤€ìœ¼ë¡œ ì„­ì·¨ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        </div>
        {% endif %}
      </div>
      
      <!-- ì—¬ì„± ê¸°ì¤€ ì¶”ì²œ -->
      <div id="female-recommendation" class="recommendation-panel">
        {% if results.female_deficient %}
        <div class="deficient-nutrients">
          <h4>ğŸ”» ë¶€ì¡±í•œ ì˜ì–‘ì†Œ:</h4>
          <div class="nutrient-chips">
            {% for nutrient, deficit in results.female_deficient.items() %}
            <span class="nutrient-chip deficient">
              {{ {
                'calories_kcal':'ì—´ëŸ‰', 'sodium_mg':'ë‚˜íŠ¸ë¥¨', 'carbs_g':'íƒ„ìˆ˜í™”ë¬¼',
                'sugars_g':'ë‹¹ë¥˜', 'fat_g':'ì§€ë°©', 'sat_fat_g':'í¬í™”ì§€ë°©', 'trans_fat_g':'íŠ¸ëœìŠ¤ì§€ë°©',
                'cholesterol_mg':'ì½œë ˆìŠ¤í…Œë¡¤', 'protein_g':'ë‹¨ë°±ì§ˆ'
              }[nutrient] }}
            </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if results.female_excessive %}
        <div class="excessive-nutrients">
          <h4>ğŸ”º ê³¼ë‹¤ ì„­ì·¨í•œ ì˜ì–‘ì†Œ:</h4>
          <div class="nutrient-chips">
            {% for nutrient, excess in results.female_excessive.items() %}
            <span class="nutrient-chip excessive">
              {{ {
                'calories_kcal':'ì—´ëŸ‰', 'sodium_mg':'ë‚˜íŠ¸ë¥¨', 'carbs_g':'íƒ„ìˆ˜í™”ë¬¼',
                'sugars_g':'ë‹¹ë¥˜', 'fat_g':'ì§€ë°©', 'sat_fat_g':'í¬í™”ì§€ë°©', 'trans_fat_g':'íŠ¸ëœìŠ¤ì§€ë°©',
                'cholesterol_mg':'ì½œë ˆìŠ¤í…Œë¡¤', 'protein_g':'ë‹¨ë°±ì§ˆ'
              }[nutrient] }}
            </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if results.female_deficient %}
        <div class="recommendation-text">
          <h4>ğŸ ë¶€ì¡±í•œ ì˜ì–‘ì†Œ ë³´ì¶© ë°©ë²•:</h4>
          <div class="recommendation-content-text">
            {% if results.female_recommendation and results.female_recommendation.strip() %}
              {{ results.female_recommendation | nl2br | safe }}
            {% else %}
              <p>ğŸ’¡ ìœ„ì— í‘œì‹œëœ ì˜ì–‘ì†Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ê· í˜• ì¡íŒ ì‹ë‹¨ì„ í†µí•´ ë¶€ì¡±í•œ ì˜ì–‘ì†Œë¥¼ ë³´ì¶©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
              <p>ğŸ” LLM APIê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒì„¸í•œ ì¶”ì²œì„ ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if results.female_excessive %}
        <div class="reduction-text">
          <h4>âš ï¸ ê³¼ë‹¤ ì„­ì·¨ ì˜ì–‘ì†Œ ê°ì†Œ ë°©ë²•:</h4>
          <div class="reduction-content-text">
            {% if results.female_reduction and results.female_reduction.strip() %}
              {{ results.female_reduction | nl2br | safe }}
            {% else %}
              <p>âš ï¸ ìœ„ì— í‘œì‹œëœ ì˜ì–‘ì†Œë¥¼ ê³¼ë‹¤ ì„­ì·¨í–ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ì˜ì–‘ì†Œê°€ ë§ì´ í¬í•¨ëœ ìŒì‹ì„ ì¤„ì´ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
              <p>ğŸ” LLM APIê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒì„¸í•œ ê°ì†Œ ë°©ë²•ì„ ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if not results.female_deficient and not results.female_excessive %}
        <div class="no-recommendation">
          <p>ğŸ‰ ëª¨ë“  ì˜ì–‘ì†Œê°€ ì ì • ìˆ˜ì¤€ìœ¼ë¡œ ì„­ì·¨ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</section>
{% endif %}

<script>
function showRecommendation(gender) {
  // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ íŒ¨ë„ì˜ active í´ë˜ìŠ¤ ì œê±°
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.recommendation-panel').forEach(panel => panel.classList.remove('active'));
  
  // ì„ íƒëœ íƒ­ ë²„íŠ¼ê³¼ íŒ¨ë„ì— active í´ë˜ìŠ¤ ì¶”ê°€
  event.target.classList.add('active');
  document.getElementById(gender + '-recommendation').classList.add('active');
}
</script>

{% endblock %}

